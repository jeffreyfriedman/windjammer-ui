name: Tests

on:
  push:
    branches: [ main, 'feature/**' ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  SKIP_WJ_REGEN: 1  # Skip regeneration in CI - generated code is committed

jobs:
  # Fast quality checks - fail immediately if issues found
  quality-checks:
    name: Code Quality (Format & Lint)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Check formatting
        run: |
          echo "üé® Checking code formatting..."
          cargo fmt --all -- --check
          echo "‚úÖ Formatting check passed"
      
      - name: Run clippy (web features)
        run: |
          echo "üîé Running clippy with web features..."
          cargo clippy --lib --tests --features web -- -D warnings
          echo "‚úÖ Clippy passed (web)"
      
      - name: Install system dependencies (for desktop clippy)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libjavascriptcoregtk-4.1-dev \
            libwebkit2gtk-4.1-dev \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev
      
      - name: Run clippy (all features)
        run: |
          echo "üîé Running clippy with all features..."
          cargo clippy --lib --tests --all-features -- -D warnings
          echo "‚úÖ Clippy passed (all features)"

  # Version consistency check (fast, independent)
  version-check:
    name: Version Consistency
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to compare with main
      
      - name: Check version consistency
        run: |
          echo "üîç Checking version consistency..."
          
          # Extract workspace version
          CARGO_VERSION=$(grep '^\[workspace.package\]' -A 10 Cargo.toml | grep '^version = ' | head -1 | sed 's/.*version = "\(.*\)"/\1/')
          echo "Workspace version: $CARGO_VERSION"
          
          # Check windjammer-ui-macro dependency version
          MACRO_DEP=$(grep 'windjammer-ui-macro.*version.*=' Cargo.toml | head -1 | sed 's/.*version = "\([^"]*\)".*/\1/')
          echo "Macro dependency version: $MACRO_DEP"
          
          if [ "$CARGO_VERSION" != "$MACRO_DEP" ]; then
            echo "‚ùå ERROR: Version mismatch!"
            echo "Workspace version: $CARGO_VERSION"
            echo "Macro dependency: $MACRO_DEP"
            echo ""
            echo "Please update Cargo.toml:"
            echo "  windjammer-ui-macro = { path = \"windjammer-ui-macro\", version = \"$CARGO_VERSION\" }"
            exit 1
          fi
          
          echo "‚úÖ Version consistency check passed"
      
      - name: Check version increment (on PRs)
        if: github.event_name == 'pull_request'
        run: |
          echo "üîç Checking version increment..."
          
          CARGO_VERSION=$(grep '^\[workspace.package\]' -A 10 Cargo.toml | grep '^version = ' | head -1 | sed 's/.*version = "\(.*\)"/\1/')
          MAIN_VERSION=$(git show origin/main:Cargo.toml | grep '^\[workspace.package\]' -A 10 | grep '^version = ' | head -1 | sed 's/.*version = "\(.*\)"/\1/')
          
          echo "Current version: $CARGO_VERSION"
          echo "Main version: $MAIN_VERSION"
          
          if [ "$CARGO_VERSION" = "$MAIN_VERSION" ]; then
            echo "‚ùå ERROR: Version not incremented!"
            echo ""
            echo "Please bump the version in Cargo.toml [workspace.package]"
            echo "Examples:"
            echo "  - Patch: $MAIN_VERSION ‚Üí $(echo $MAIN_VERSION | awk -F. '{print $1"."$2"."$3+1}')"
            echo "  - Minor: $MAIN_VERSION ‚Üí $(echo $MAIN_VERSION | awk -F. '{print $1"."$2+1".0"}')"
            exit 1
          fi
          
          echo "‚úÖ Version incremented: $MAIN_VERSION ‚Üí $CARGO_VERSION"

  # Cross-platform tests - only run if quality checks pass
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: [quality-checks, version-check]  # Wait for quality checks to pass
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Generate Cargo.lock if missing
        shell: bash
        run: cargo generate-lockfile
      
      - name: Cache cargo dependencies
        continue-on-error: true
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libjavascriptcoregtk-4.1-dev \
            libwebkit2gtk-4.1-dev \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev
      
      - name: Build (web features)
        run: cargo build --verbose --features web
      
      - name: Run tests (web features)
        run: cargo test --verbose --features web
      
      - name: Build (all features) - macOS only
        if: runner.os == 'macOS'
        run: cargo build --verbose --all-features
      
      - name: Run tests (all features) - macOS only
        if: runner.os == 'macOS'
        run: cargo test --verbose --all-features
      
      - name: Build release
        run: cargo build --release --verbose --features web
      
      - name: Build for WASM target (Linux only)
        if: runner.os == 'Linux'
        run: |
          rustup target add wasm32-unknown-unknown
          cargo build --target wasm32-unknown-unknown --features web

  # Code coverage (independent, can run in parallel)
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [quality-checks]  # Only need quality checks to pass
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install system dependencies
        run: |
          set -ex
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libjavascriptcoregtk-4.1-dev \
            libwebkit2gtk-4.1-dev \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev
          
          # Verify pkg-config can find the libraries
          echo "=== Verifying pkg-config can find libraries ==="
          pkg-config --modversion glib-2.0
          pkg-config --modversion gobject-2.0
          pkg-config --modversion gio-2.0
          pkg-config --modversion gtk+-3.0
          echo "=== All libraries found! ==="
      
      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin
      
      - name: Clean build artifacts
        run: cargo clean
      
      - name: Generate coverage
        run: cargo tarpaulin --verbose --features web --workspace --timeout 120 --out xml
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./cobertura.xml
          fail_ci_if_error: false
  
  # Validate Cargo.lock (fast, independent)
  lockfile-check:
    name: Cargo.lock Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Check Cargo.lock exists
        run: |
          if [ ! -f "Cargo.lock" ]; then
            echo "‚ùå ERROR: Cargo.lock is not committed!"
            echo "Please run 'cargo generate-lockfile' and commit Cargo.lock"
            exit 1
          fi
          echo "‚úÖ Cargo.lock is committed"
      
      - name: Verify Cargo.lock is up-to-date
        run: |
          echo "üîç Checking if Cargo.lock is up-to-date with Cargo.toml..."
          cp Cargo.lock Cargo.lock.before
          cargo update --workspace --dry-run
          if ! diff Cargo.lock Cargo.lock.before > /dev/null 2>&1; then
            echo "‚ùå ERROR: Cargo.lock is out of sync with Cargo.toml!"
            echo "Please run 'cargo update' and commit the updated Cargo.lock"
            exit 1
          fi
          echo "‚úÖ Cargo.lock is up-to-date"
  
  # Validate that crate can be published
  publish-dryrun:
    name: Publish Dry-Run
    runs-on: ubuntu-latest
    needs: [quality-checks, lockfile-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache Cargo registry and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-publish-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-publish-
            ${{ runner.os }}-cargo-
      
      - name: Dry-run publish
        run: |
          echo "üß™ Validating windjammer-ui-macro can be published..."
          # Only test macro crate since main crate depends on it
          # (and dry-run doesn't actually publish, so dependency check would fail)
          cd windjammer-ui-macro
          cargo publish --dry-run --allow-dirty
          cd ..
          echo "‚úÖ windjammer-ui-macro is ready to publish!"
          echo "‚ÑπÔ∏è  Main crate will be validated during actual release"

