name: Tests

on:
  push:
    branches: [ main, 'feature/**' ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test on ${{ matrix.os }} with Rust ${{ matrix.rust }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]
        # Beta testing disabled due to winit platform support issues on Linux
        # include:
        #   - os: ubuntu-latest
        #     rust: beta
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy
      
      - name: Generate Cargo.lock if missing
        shell: bash
        run: cargo generate-lockfile
      
      - name: Cache cargo dependencies
        continue-on-error: true
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libjavascriptcoregtk-4.1-dev \
            libwebkit2gtk-4.1-dev \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev
      
      - name: Install Windjammer CLI
        run: cargo install windjammer --version ^0.38.3 --locked
      
      - name: Build
        run: cargo build --verbose
      
      - name: Check formatting
        if: matrix.rust == 'stable' && matrix.os == 'ubuntu-latest'
        run: cargo fmt --all -- --check
      
      - name: Run clippy (macOS)
        if: matrix.rust == 'stable' && runner.os == 'macOS'
        run: cargo clippy --all-targets --all-features -- -D warnings
      
      - name: Run clippy (Linux/Windows)
        if: matrix.rust == 'stable' && runner.os != 'macOS'
        run: cargo clippy --all-targets --features web -- -D warnings
      
      - name: Run tests (macOS)
        if: runner.os == 'macOS'
        run: cargo test --verbose --all-features
      
      - name: Run tests (Linux/Windows)
        if: runner.os != 'macOS'
        run: cargo test --verbose --features web
      
      - name: Build release
        if: matrix.rust == 'stable'
        run: cargo build --release --verbose
      
      - name: Test package (dry-run)
        if: matrix.rust == 'stable' && matrix.os == 'ubuntu-latest'
        run: cargo publish --dry-run --allow-dirty
      
      - name: Build with desktop feature
        if: matrix.rust == 'stable' && runner.os == 'macOS'
        run: cargo build --release --features desktop
      
      - name: Build for WASM target
        if: matrix.rust == 'stable' && matrix.os == 'ubuntu-latest'
        run: |
          rustup target add wasm32-unknown-unknown
          cargo build --target wasm32-unknown-unknown --features web

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install system dependencies
        run: |
          set -ex
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libjavascriptcoregtk-4.1-dev \
            libwebkit2gtk-4.1-dev \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev
          
          # Verify pkg-config can find the libraries
          echo "=== Verifying pkg-config can find libraries ==="
          pkg-config --modversion glib-2.0
          pkg-config --modversion gobject-2.0
          pkg-config --modversion gio-2.0
          pkg-config --modversion gtk+-3.0
          echo "=== All libraries found! ==="
      
      - name: Install Windjammer CLI
        run: cargo install windjammer --locked
      
      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin
      
      - name: Clean build artifacts
        run: cargo clean
      
      - name: Generate coverage
        run: cargo tarpaulin --verbose --features web --workspace --timeout 120 --out xml
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./cobertura.xml
          fail_ci_if_error: false
  
  # Validate Cargo.lock is committed and up-to-date
  lockfile-check:
    name: Cargo.lock Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Check Cargo.lock exists
        run: |
          if [ ! -f "Cargo.lock" ]; then
            echo "‚ùå ERROR: Cargo.lock is not committed!"
            echo "Please run 'cargo generate-lockfile' and commit Cargo.lock"
            exit 1
          fi
          echo "‚úÖ Cargo.lock is committed"
      
      - name: Verify Cargo.lock is up-to-date
        run: |
          echo "üîç Checking if Cargo.lock is up-to-date with Cargo.toml..."
          cp Cargo.lock Cargo.lock.before
          cargo update --workspace --dry-run
          if ! diff Cargo.lock Cargo.lock.before > /dev/null 2>&1; then
            echo "‚ùå ERROR: Cargo.lock is out of sync with Cargo.toml!"
            echo "Please run 'cargo update' and commit the updated Cargo.lock"
            exit 1
          fi
          echo "‚úÖ Cargo.lock is up-to-date"
  
  # Validate that crate can be published (dry-run)
  publish-dryrun:
    name: Publish Dry-Run
    runs-on: ubuntu-latest
    needs: [lockfile-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Windjammer CLI
        run: cargo install windjammer --locked
      
      - name: Cache Cargo registry and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-publish-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-publish-
            ${{ runner.os }}-cargo-
      
      - name: Dry-run publish
        run: |
          echo "üß™ Validating windjammer-ui-macro can be published..."
          # Only test macro crate since main crate depends on it
          # (and dry-run doesn't actually publish, so dependency check would fail)
          cd windjammer-ui-macro
          cargo publish --dry-run --allow-dirty
          cd ..
          echo "‚úÖ windjammer-ui-macro is ready to publish!"
          echo "‚ÑπÔ∏è  Main crate will be validated during actual release"

