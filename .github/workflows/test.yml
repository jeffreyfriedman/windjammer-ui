name: Tests

on:
  push:
    branches: [ main, 'feature/**' ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test on ${{ matrix.os }} with Rust ${{ matrix.rust }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]
        include:
          # Test with beta on Ubuntu only
          - os: ubuntu-latest
            rust: beta
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Linux system dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libglib2.0-dev libjavascriptcoregtk-4.1-dev libwebkit2gtk-4.1-dev
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy
      
      - name: Install Windjammer CLI
        shell: bash
        run: |
          echo "ğŸ“¦ Installing Windjammer CLI v0.36.2..."
          cargo install windjammer --version 0.36.2
          echo "âœ… Windjammer CLI installed"
          wj --version
      
      - name: Generate Cargo.lock if missing
        shell: bash
        run: cargo generate-lockfile
      
      - name: Cache cargo dependencies
        continue-on-error: true
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Build
        run: cargo build --verbose
      
      - name: Check formatting
        if: matrix.rust == 'stable' && matrix.os == 'ubuntu-latest'
        run: cargo fmt --all -- --check
      
      - name: Run clippy
        if: matrix.rust == 'stable'
        run: cargo clippy --all-targets --all-features -- -D warnings
      
      - name: Run tests
        run: cargo test --verbose --all-features
      
      - name: Build release
        if: matrix.rust == 'stable'
        run: cargo build --release --verbose
      
      - name: Build with desktop feature
        if: matrix.rust == 'stable' && runner.os != 'Windows'
        run: cargo build --release --features desktop
      
      - name: Build for WASM target
        if: matrix.rust == 'stable' && matrix.os == 'ubuntu-latest'
        run: |
          rustup target add wasm32-unknown-unknown
          cargo build --target wasm32-unknown-unknown --features wasm

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Windjammer CLI
        run: |
          echo "ğŸ“¦ Installing Windjammer CLI v0.36.2..."
          cargo install windjammer --version 0.36.2
          echo "âœ… Windjammer CLI installed"
          wj --version
      
      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin
      
      - name: Generate coverage
        run: cargo tarpaulin --verbose --all-features --workspace --timeout 120 --out xml
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./cobertura.xml
          fail_ci_if_error: false
  
  # Validate Cargo.lock is committed and up-to-date
  lockfile-check:
    name: Cargo.lock Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Check Cargo.lock exists
        run: |
          if [ ! -f "Cargo.lock" ]; then
            echo "âŒ ERROR: Cargo.lock is not committed!"
            echo "Please run 'cargo generate-lockfile' and commit Cargo.lock"
            exit 1
          fi
          echo "âœ… Cargo.lock is committed"
      
      - name: Verify Cargo.lock is up-to-date
        run: |
          echo "ğŸ” Checking if Cargo.lock is up-to-date with Cargo.toml..."
          cp Cargo.lock Cargo.lock.before
          cargo update --workspace --dry-run
          if ! diff Cargo.lock Cargo.lock.before > /dev/null 2>&1; then
            echo "âŒ ERROR: Cargo.lock is out of sync with Cargo.toml!"
            echo "Please run 'cargo update' and commit the updated Cargo.lock"
            exit 1
          fi
          echo "âœ… Cargo.lock is up-to-date"
  
  # Validate that crate can be published (dry-run)
  publish-dryrun:
    name: Publish Dry-Run
    runs-on: ubuntu-latest
    needs: [lockfile-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Windjammer CLI
        run: |
          echo "ğŸ“¦ Installing Windjammer CLI v0.36.2..."
          cargo install windjammer --version 0.36.2
          echo "âœ… Windjammer CLI installed"
          wj --version
      
      - name: Cache Cargo registry and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-publish-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-publish-
            ${{ runner.os }}-cargo-
      
      - name: Dry-run publish windjammer-ui-macro
        run: |
          echo "ğŸ§ª Validating windjammer-ui-macro can be published..."
          cargo publish --dry-run -p windjammer-ui-macro
          echo "âœ… windjammer-ui-macro is ready to publish!"
      
      - name: Dry-run publish windjammer-ui
        run: |
          echo "ğŸ§ª Validating windjammer-ui can be published..."
          echo "âš ï¸  Skipping windjammer-ui dry-run because it depends on unpublished windjammer-ui-macro"
          echo "   This will be validated during actual publish after windjammer-ui-macro is live."
          # cargo publish --dry-run  # Can't run until windjammer-ui-macro is on crates.io
          echo "âœ… windjammer-ui-macro dry-run passed - main package will be validated during release!"

